# LHAASIM  

LhaaSim is a fast simulation of the KM2A detector, main part of LHAASO observatory. LhaaSim is a C++ software, using ROOT and CMT environment. It is a dedicated program containing only main processes. Its flexible structure is a precious advantage for an easy adaptation to different prototype of detectors.    

The goal of LhaaSim is to reproduce the charge generated by particles, with an energy and direction given, after interaction in the ED/MD detector but also the time and charge distributions.


## 1- Installation
Before the compilation, we need to install some software and define env. :

**Softwares needed :**
- ROOT : any version
- CMT (for example v1r12p20020606)
- CDAS : the present version uses IoSd v2r6, but can be updated
- Corsika & Aires libraries (libAires.a & libCors.a)

**Environment variables to be correctly defined :**
- ROOTSYS, PATH & LD_LIBRARY_PATH as usual with ROOT 
- AIRESLIB or/and CORSLIB
- CMTPATH


## 2- Compilation
Once everything is installed, we can compile :
```
cd LHAASIM/LhaaSim/v*r*/cmt;
cmt broadcast; cmt config;
cmt broadcast gmake;
```


## 3- Running
To run the software, we need two steps:

- The first step is conversion CorsToRoot or AiresToRoot.
WARNING!!!! with the present version of CorsToRoot, ONLY 2 ARGUMENTS ARE NEEDED, the file for groundparticles, and the output file. YOU DONT NEED THE ".long" FILE
- The second step is run LhaaSim. 
In the same folder you will need to update the file "default.inp" according to your needs it will be read by LhaaSim.


### FILL INPUT FILE
The input file is on */LHAASIM/LhaaSim/v*r*/data/default.inp*.
The first part is for all modes of simulation :
**mode** 
- SHOWER  
Shower simulations reading a root file  "filename.root".
The output file will be "Sim_filename.root"
- CALIB
Injection of particles in a single tank ,  there is one event per particle injected. The output file name is given by the program.

**simmode**
- DETAILED (mode currently used)
The detail of the simulation of particle and follow up of photons is simulated  
- FAST  (not anymore implemented in the present version)      
- SAMPLE 
Stops the simulation at the stage of the sampling of particles in tanks.


**muemmode**
- MUEM
Give in addition to the usual traces, separate traces for muonic and EM compo.
- DEFAULT
Give only the usual traces.

**elecmode**
- DEFAULT
 Give the time profile of particules for each PMT and the final traces for all channels.
- PM
Give in addition the profiles in time after PM simulation for each channel.
- FULL
Give all  profiles for the intermediate steps of the electronic simulation, after PM and after Front End, in addition of default mode.
- SHOWSAT
Give additionnal FADC traces where the saturation due to coding is not applied.

**number of events**
- for showers, number of time the same shower is simulated.
- for calib , number of particules entering a tank.


**THIS SECOND PART IS RELEVANT ONLY IN CALIB MODE BUT IS ALWAYS READ BY THE PROGRAM :**

**runnumber**

**partmode**	
- VEM		
Only vertical and central muons of 1 GeV are injected       
- SCINTILLATOR
Position and size  of scintillators are read in Calib.h and the trajectory of particles injected  are calculated.
- FIXEDTHETA
A flux of particles is injected with a given theta chosen below and with phi all around the tank.
- HORIZONTAL
Flux of horizontal muons all around the tank, inject ad mid height.
- RANDOM
Flux of muons follwing a sin2theta distribution.

**partcode**
- 1 for photons,
- 2 for electrons,
- 3 for muons.

**partenergy**
Energy in GeV , if equal to zero, it will be an energy distribution following a spectrum defined in "Calib.h".

**parttheta**
Theta of particles relevant only in FIXEDTHETA mode.

**partaddmode**
- DEFAULT  
Only per particle par event.       
- DOUBLE
2 particles of the same kind an energy are simulated in a event, the second particle is delayed of a random time between 0 and 3 microseconds (the ToT window).
- MULTIPLE
N particles of same energy and kind is simulated at the same time, the number of particles is read below.

**npartmultiple**

See above , relevant only in MULTIPLE mode
